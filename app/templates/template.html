<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <!-- <script src="./jquery-3.5.1.min.js" type="text/javascript"></script> -->
  <!-- <script src="./jquery-3.5.1.min.js"></script> -->
  <!-- better to have the file locally -->
  <script type=text/javascript src="{{
    url_for('static', filename='jquery.js') }}"></script>
  <script type=text/javascript src="https://d3js.org/d3.v5.min.js"></script>
  <meta charset="utf-8">
  <title>Kern Systems</title>
  <!-- <script src="jquery-3.5.1.min.js"></script> -->
  <link rel="stylesheet" href="{{ url_for('static',     filename='css/template.css') }}">
</head>
<script>
  function stringToDNA(e) {
    // post to the Flask endpoint that makes a call to the CLI
    // check jquery
    // if (typeof jQuery != 'undefined') {  
    // // jQuery is loaded => print the version
    //     alert(jQuery.fn.jquery);
    // } else {
    //   alert('not ready')
    // }
    // should not change the url because of prevent default
    e.preventDefault();
    var input = document.getElementById('word1').value;

    var data = {
      "input": document.getElementById('word1').value,
    };
    $.ajax({
      type: 'POST',
      contentType: 'application/json',
      url: '/encode_string',
      dataType: 'json',
      data: JSON.stringify(data),
      // need a callback after success because ajax is async
      success: function (result) {
        console.log('success');
        callback(result);
      },
      error: function (result) {
        console.log('failure');
        console.log(result);
        console.log(result['status']);
        // raise the error
        // callback("failure");
      }
    });

    function callback(data) {
      console.log(data);
      document.getElementById("output_header").innerHTML = "Encoding results for: " + input;
      document.getElementById("output_word").innerHTML = data["word"];
      document.getElementById("payload_trits").innerHTML = "Payload Trits: " + data["payload_trits"];
      document.getElementById("address_bits").innerHTML = "Address Length: " + data["address_length"];
      document.getElementById("payload_trits").style.display = "block";
      generateGraph(data["letter_dict"]);
      document.getElementById("graph").style.display = "block";
      document.getElementById("synthesis_length").style.display = "none";
    }
  }
  window.onload = function () {
    const form = document.getElementById('dna_form');
    // necessary because otherwise the form wasn't ready
    form.addEventListener('submit', (e) => {
      // prevents the form from submitting by user click, waits for 
      // promise to resolve before submitting
      e.preventDefault();
      DNAtoString(form);
    });
  }

  function DNAtoString(form) {
    // e.preventDefault();
    var input = document.getElementById('word2').value;
    // error check input
    var strandLength = -1;
    var seen = 0;
    var letters = 0;
    var testInput = ""
    input = input.trim();
    if (input.slice(-1) != ",") {
      testInput = input + ",";
    } else {
      testInput = input;
    }
    var cleanInput = "";
    // var letters = true;
    for (c of testInput) {
      if (c == ',' && strandLength == -1) {
        if (seen == 0) {
          alert("Can't start with comma");
          return;
        }
        cleanInput += c;
        strandLength = seen;
        seen = 0;
      } else if (seen != strandLength && c == ",") {
        alert('Strands must be the same length');
        return;
      } else if (c == ",") {
        cleanInput += c;
        seen = 0;
      } else if ("agctAGCT".includes(c)) {
        seen++;
        letters++;
        cleanInput += c;
      } else if (/\s/.test(c)) {
        continue;
      } else {
        alert('Invalid characters. Must be AGCT');
        return;
      }
    }
    // if (letters < 7) {
    //   alert('DNA must be 7+ letters')
    //   return;
    // }
    var data = {
      "input": cleanInput.slice(0, -1),
    };
    const options = {
      method: "POST",
      body: JSON.stringify(data),
      headers: new Headers({
        'content-type': 'application/json',
        'Accept': 'application/json',
        dataType: "json",
      }),
    };

    fetch('/decode_string', options)
      .then((data) => {
        if (data.ok) {
          // alert('returning json');
          return data.json();
        } else {
          alert('An error has occurred returning the data. Check console for data log.');
          console.log(data);
        }
      })
      .then((data) => {
        document.getElementById("output_header").innerHTML = "Decoding results:";
        document.getElementById("synthesis_length").innerHTML = "Synthesis Length: " + data["synthesis_length"];
        document.getElementById("address_bits").innerHTML = "Address Length: " + data["address_length"];
        document.getElementById("output_word").innerHTML = data["word"];
        document.getElementById("payload_trits").style.display = "none";
        document.getElementById("graph").style.display = "none";
        document.getElementById("synthesis_length").style.display = "block";
      })
      .catch((error) => {
        alert('An error has occurred returning the data. Check console for data log.');
        console.log(data);
      });

  }

  // Not working right now
  function parseFile(input) {

    document.getElementById('output').src = window.URL.createObjectURL(input.files[0]);
    let file = input.files[0];
    const options = {
      method: "POST",
      body: file,
      // contentType: 'enctype=multipart/form-data',
    }
    // delete options.headers['Content-Type'];

    fetch('/upload_file', options).then(
      function (response) {
        if (response.ok) {
          // a new promise that resolves when text loads
          alert("HTTP-WORKED: " + response.status);
          alert(response);
        } else {
          alert("HTTP-Error: " + response.status);
        }
      }
    );
    // .then(
    //   // after response.text() resolves
    //   // alerts the DNA representation
    //   text => alert(text)
    // );
  }
</script>

<body>
  <header>
    <h1 class="logo">Kern Systems</h1>
  </header>
  <div class="inputbox">
    <h1 class="dna_header">String - DNA Converter</h1>
    <!-- <form method="post" onsubmit="callCLI()"> -->
    <form onsubmit="stringToDNA(event)">
      <textarea id="word1" name="word" placeholder="Type your string here... e.g. hello"></textarea>
      <input type="submit" name="submit_button_str" value="Encode your input!">
    </form>
    <form id="dna_form">
      <textarea id="word2" name="word"
        placeholder="Type your DNA here... e.g. TCACA,TCAGC,TAGAG,TAGAG,TAGTC"></textarea>
      <input type="submit" name="submit_button_dna" value="Decode DNA">
    </form>
  </div>
  <!-- Will work on this later -->
  <!-- <input id="image-file" type="file" name="picture" onchange="parseFile(this)"> -->
  <!-- <img id="output" src="" width="100" height="100"> -->

  <!-- for showing the graph results -->
  <h2 id="output_header"></h2>
  <textarea id="output_word" readonly></textarea>
  <div id="graph"></div>
  <!-- for address bits and payload trits -->
  <h2 id="address_bits"></h2>
  <h2 id="payload_trits"></h2>
  <h2 id="synthesis_length"></h2>

  <script>
    function generateGraph(input) {
      d3.select(".graphSvg").remove();
      var data = d3.entries(input);
      var margin = 200;
      var barWidth = 80;
      var marginBetweenBars = 5;
      var groupXOffset = 100;
      var groupYOffset = 50;

      var maxBarHeight = d3.max(data, function (d) {
        return d.value;
      });
      var yAxisHeight = 400;
      var numBars = Object.keys(input).length;
      var xAxisWidth = (barWidth + marginBetweenBars) * numBars;

      var svgWidth = xAxisWidth + groupXOffset;
      var svgHeight = yAxisHeight + margin;

      var svg = d3.select("#graph").append("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight)
        .attr("class", "graphSvg")

      // y axis has the frequency of letters appearing in the DNA template
      var yScale = d3.scaleLinear()
        .range([yAxisHeight, 0])
        .domain([0, maxBarHeight]);
      // X axis has the four letters
      var xScale = d3.scaleBand()
        .range([0, xAxisWidth])
        .domain(Object.keys(input));
      var g = svg.append("g")
        // transformation applied to all chldren of the group
        .attr("transform", "translate(" + groupXOffset + "," + groupYOffset + ")");

      g.append("g")
        .attr("transform", "translate(0," + yAxisHeight + ")")
        .call(d3.axisBottom(xScale))
        .append("text")
        .style("font", "20px times")
        .style("fill", "black")
        .attr("y", 40)
        .attr("x", xAxisWidth / 2)
        .text("DNA letter");
      g.append("g")
        .attr("transform", "translate(0," + 0 + ")")
        .call(d3.axisLeft(yScale))
        .append("text")
        .style("font", "20px times")
        .attr("transform", "rotate(-90)")
        .style("fill", "black")
        .attr("y", -50)
        .attr("x", -120)
        .text("Frequency of letter in DNA");
      g.selectAll(".bar")
        .data(data)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("x", function (d) {
          return xScale(d.key)
        })
        .attr("y", function (d) {
          return yScale(d.value);
        })
        .attr("width", barWidth - marginBetweenBars)
        .attr("height", function (d) {
          return yAxisHeight - yScale(d.value);
        });
    }
  </script>

  {% block content %}
  {% endblock %}

</body>

</html>